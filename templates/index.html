<!DOCTYPE html>
<html>
	<head>
		<script src='https://code.responsivevoice.org/responsivevoice.js'></script>
		<script>
			var API_URL = '/api';
			
			var canvas,
				ctx,
				inputForm;
			
			window.onload = function () {
				canvas = document.getElementById("output");
				ctx = canvas.getContext("2d");
				inputForm = document.getElementById("inputForm");
				inputForm.onsubmit = processText;
			};
			
			function processText(e) {
				e.preventDefault();
				e.stopPropagation();
				
				var text = e.target.inputBox.value,
					xhr = new XMLHttpRequest();
				xhr.open('POST', API_URL, true);
				xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
				xhr.onreadystatechange = function () {
					if (xhr.readyState === 4) {
						if (xhr.status === 200) {
							var sentences = [];
							try {
								sentences = JSON.parse(xhr.responseText);
							} catch (ex) {
								handleError();
							}
							dispSentences(sentences);
						} else {
							handleError();
						}
					}
				};
				xhr.send('text=' + encodeURIComponent(text));
				
			}
			
			function handleError() {
				// TODO: Do something more user-friendly.
				alert('Something went wrong!');
			}
			
			function dispSentences(sentences) {
				sentences.forEach(function (sentence) {
					writeText(sentence.text);
				});
			}
			
			function gradientColor(sentiment) {
				p = (sentiment + 1.0) / 2.0;
				
				var colorOut = "rgb(" + Math.round(255*p) + ",0," + Math.round(255*(1-p)) + ")";
				console.log(colorOut);
				return colorOut;
			}
			
			function writeText(string){
				clear();
				ctx.font = "24px Arial";
				ctx.fillStyle = gradientColor(Math.random());
				ctx.fillText(string, 10,34);
			}
			
			function clear() {
				color = canvas.fillStyle;
				ctx.fillStyle = "#ffffff";
				ctx.fillRect(0,0,document.getElementById("output").width, document.getElementById("output").height);
				
				//reset color
				ctx.fillStyle = color;
			}
		</script>
	</head>
	<body>
		<canvas id="output" width="640" height="480">
		</canvas>
		<br />
		<form id="inputForm" method="POST">
			<textarea name="inputBox" rows="10" cols="30">Enter your text here.
			</textarea>
			<br />
			<button type="submit">Visualize!</button>
		</form>
	</body>
</html>
